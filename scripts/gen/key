#!/bin/bash

set -e

ROOT_PATH="$(git rev-parse --show-toplevel)"
source ${ROOT_PATH}/scripts/helper

print_header "Generating $1 key"

arr_type=(aes server jwt grpc)
if [[ " ${arr_type[@]} " =~ " $1 " ]]; then
  if [ "$1" == "aes" ]; then
    print_answer "SUCCESS" green
    hexdump -vn16 -e'4/4 "%08X" 1 "\n"' /dev/urandom
  elif [ "$1" == "server" ]; then
    if [ -f ${ROOT_PATH}/.vscode/core/server.key ]; then
      rm -rf ${ROOT_PATH}/.vscode/core/server.key*
    fi
    ssh-keygen -t rsa -b 4096 -f ${ROOT_PATH}/.vscode/core/server_key -N '' -C 'werbot@core' >/dev/null 2>&1
    rm -rf ${ROOT_PATH}/.vscode/core/server_key.pub
    mv ${ROOT_PATH}/.vscode/core/server_key ${ROOT_PATH}/.vscode/core/server.key
    print_answer "SUCCESS" green
  elif [ "$1" == "jwt" ]; then
    openssl genrsa -out ${ROOT_PATH}/.vscode/core/jwt_private.key 2048
    openssl rsa -in ${ROOT_PATH}/.vscode/core/jwt_private.key -pubout -outform PEM -out ${ROOT_PATH}/.vscode/core/jwt_public.key >/dev/null 2>&1
    print_answer "SUCCESS" green
  elif [ "$1" == "grpc" ]; then
    if ! [ -d ${ROOT_PATH}/.vscode/tmp ]; then
      mkdir ${ROOT_PATH}/.vscode/tmp
    fi

    cat <<EOF >${ROOT_PATH}/.vscode/tmp/.temp-openssl-config
[ req ]
prompt                 = no
req_extensions         = req_ext
distinguished_name     = req_distinguished_name

[ req_distinguished_name ]
countryName            = US
stateOrProvinceName    = Delaware
localityName           = Middletown
organizationName       = Werbot, Inc.
organizationalUnitName = werbot
commonName             = werbot.com

[ req_ext ]
subjectAltName         = @alt_names

[ alt_names ]
DNS.1                  = werbot.com
EOF

    openssl genrsa -out ${ROOT_PATH}/.vscode/tmp/private_key.pem 2048
    openssl req -nodes -new -x509 -sha256 -days 1825 -config ${ROOT_PATH}/.vscode/tmp/.temp-openssl-config \
      -extensions 'req_ext' \
      -key ${ROOT_PATH}/.vscode/tmp/private_key.pem \
      -out ${ROOT_PATH}/.vscode/tmp/certificate.pem
    mv ${ROOT_PATH}/.vscode/tmp/private_key.pem ${ROOT_PATH}/.vscode/core/grpc_private.key
    mv ${ROOT_PATH}/.vscode/tmp/certificate.pem ${ROOT_PATH}/.vscode/core/grpc_certificate.key
    rm -rf ${ROOT_PATH}/.vscode/tmp

    print_answer "SUCCESS" green
  fi
else
  print_answer "ERROR" red
  echo "Parameters not passed"
  exit
fi
